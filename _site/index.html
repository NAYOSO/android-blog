<!DOCTYPE html>
<html lang="en-us">

  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta content="967315276669536" property="fb:app_id">
    <meta content="Niko Yuwono" property="og:site_name">
    
      <meta content="Home" property="og:title">
    
    
      <meta content="article" property="og:type">
    
    
      <meta content="Hello, I'm Niko Yuwono. I'm a software engineer based in Tokyo, Japan and this is my blog about Computer Vision and Android Development." property="og:description">
    
    
      <meta content="http://nikoyuwono.github.io//" property="og:url">
    
    
    
      <meta content="/assets/images/niko.jpeg" property="og:image">
    
    
    
    <title>
    
      Niko Yuwono &middot; 
    
    </title>

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/poole.css">
    <link rel="stylesheet" href="/public/css/syntax.css">
    <link rel="stylesheet" href="/public/css/hyde.css">
    <link rel="stylesheet" href="/public/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/public/favicons/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/public/favicons/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/public/favicons/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/public/favicons/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/public/favicons/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/public/favicons/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/public/favicons/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/public/favicons/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/public/favicons/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/public/favicons/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/public/favicons/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="/public/favicons/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/public/favicons/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/public/favicons/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/public/favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-TileImage" content="/public/favicons/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">  
  <div class=darker></div>
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="/">
        <div class="circular"></div>
      </a>
      <p></p>
      <p class="description">Hello, I'm Niko Yuwono. I'm a software engineer based in Tokyo, Japan and this is my blog about Computer Vision and Android Development.</p>
    </div>
    
    <a href="https://github.com/NikoYuwono"><i class="fa fa-github fa-2x fa-inverse icon-center"></i></a>
    <a href="http://stackoverflow.com/users/1545363/niko-yuwono"><i class="fa fa-stack-overflow fa-2x fa-inverse icon-center"></i></a>
    <a href="https://www.linkedin.com/in/nikoyuwono"><i class="fa fa-linkedin fa-2x fa-inverse icon-center"></i></a>
    <a href="https://twitter.com/niko_yuwono"><i class="fa fa-twitter fa-2x fa-inverse icon-center"></i></a>
    <p></p>
    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/10/05/receipt-scanner/">
        Receipt Scanner (Text Detection)
      </a>
    </h1>

    <span class="post-date">05 Oct 2015</span>

    <p>Text extraction from image becomes more popular these days. For example text translation from images, receipt scanner, paper scanner, etc.<br>
But the question is, how is it done? First, to recognize what texts inside the image we need to know where the texts are <strong>located</strong> and that&#39;s our topic today.</p>

<p>My approaches to detect where the texts are:  </p>

<ol>
<li>Change color space from BGR (or RGB) to Gray<br></li>
<li>Apply Morphological Gradient<br></li>
<li>Apply threshold to convert to binary image</li>
<li>Apply Closing Morphological Transformation<br></li>
<li>Find contours and filter it<br></li>
</ol>

<p>Let&#39;s take a look at each step in detail.</p>

<h3>Original Image</h3>

<p><img src="/assets/text_detection/original.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<h3>Change color space from BGR to Gray.</h3>

<p>In image processing it&#39;s pretty common to change the color space from BGR (or RGB) to Gray. One of the reason is luminance is by far more important in distinguishing visual features compared to chrominance (<a href="https://www.quora.com/Computer-Vision/If-you-had-to-choose-would-you-rather-go-without-luminance-or-chrominance/answer/John-Zhang">Good explanation by John Zhang</a>).<br>
To convert image from BGR (or RGB) to Gray color space in OpenCV is quite simple.  </p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Mat</span> <span class="n">original</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">&quot;receipt.jpg&quot;</span><span class="p">);</span>
<span class="n">Mat</span> <span class="n">gray</span><span class="p">;</span>
<span class="n">cvtColor</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="n">CV_BGR2GRAY</span><span class="p">);</span></code></pre></div>
  

<p>Result :<br>
<img src="/assets/text_detection/gray.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<h3>Apply Morphological Gradient.</h3>

<p>Morphological Gradient is a combination from dilation and erosion. Where dilation will act as local maximum operator and erosion as local minimum operator.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Mat</span> <span class="n">gradient</span><span class="p">;</span>
<span class="n">Mat</span> <span class="n">morphStructure</span> <span class="o">=</span> <span class="n">getStructuringElement</span><span class="p">(</span><span class="n">MORPH_ELLIPSE</span><span class="p">,</span> <span class="n">Size</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
<span class="n">morphologyEx</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">gradient</span><span class="p">,</span> <span class="n">MORPH_GRADIENT</span><span class="p">,</span> <span class="n">morphStructure</span><span class="p">);</span></code></pre></div>
  

<p>Which morphStructure is kernel of structuring element that will define how the gradient will be calculated.<br>
To understand more about dilaton and erosion you can check really nice demonstration in OpenCV&#39;s example <a href="http://docs.opencv.org/master/d9/d61/tutorial_py_morphological_ops.html#gsc.tab=0">here</a></p>

<p>Result :<br>
<img src="/assets/text_detection/gradient.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<h3>Apply threshold to convert to binary image</h3>

<p>I&#39;m using Otsu algorithm to choose the optimal threshold value to convert the processed image to binary image.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Mat</span> <span class="n">binary</span><span class="p">;</span>
<span class="n">threshold</span><span class="p">(</span><span class="n">gradient</span><span class="p">,</span> <span class="n">binary</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">THRESH_BINARY</span> <span class="o">|</span> <span class="n">THRESH_OTSU</span><span class="p">);</span></code></pre></div>
  

<p>Result :<br>
<img src="/assets/text_detection/binary.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<h3>Apply Closing Morphological Transformation</h3>

<p>And the last one before we can find the contours we need to do Closing Morphological Transformation which is dilation followed by erosion that will close small holes between words so we can group it into a sentence horizontally.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Mat</span> <span class="n">closed</span><span class="p">;</span>
<span class="n">morphStructure</span> <span class="o">=</span> <span class="n">getStructuringElement</span><span class="p">(</span><span class="n">MORPH_RECT</span><span class="p">,</span> <span class="n">Size</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="n">morphologyEx</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span> <span class="n">closed</span><span class="p">,</span> <span class="n">MORPH_CLOSE</span><span class="p">,</span> <span class="n">morphStructure</span><span class="p">);</span></code></pre></div>
  

<p>Result :<br>
<img src="/assets/text_detection/closed.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<h3>Find contours and filter it</h3>

<p>After all the processing it&#39;s time to find contours and filter it so we finally can locate where the texts are located.</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Find contours</span>
<span class="n">Mat</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">Mat</span><span class="o">::</span><span class="n">zeros</span><span class="p">(</span><span class="n">bw</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">CV_8UC1</span><span class="p">);</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Point</span><span class="o">&gt;&gt;</span> <span class="n">contours</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">Vec4i</span><span class="o">&gt;</span> <span class="n">hierarchy</span><span class="p">;</span>
<span class="n">findContours</span><span class="p">(</span><span class="n">connected</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">CV_RETR_CCOMP</span><span class="p">,</span> <span class="n">CV_CHAIN_APPROX_SIMPLE</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="c1">// Filter contours</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="p">{</span>
    <span class="n">Rect</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">boundingRect</span><span class="p">(</span><span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="c1">// Ignore if the rect is too small</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Mat</span> <span class="n">maskROI</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>
    <span class="n">maskROI</span> <span class="o">=</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">drawContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">CV_FILLED</span><span class="p">);</span>
    <span class="c1">// Calculate ratio of non-zero pixels in the filled region</span>
    <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">countNonZero</span><span class="p">(</span><span class="n">maskROI</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

    <span class="c1">// If the ration is bigger than 45% we assume it contains texts</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.45</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rectangle</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">Scalar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
  

<p>Result :<br>
<img src="/assets/text_detection/result.jpg" height="75%" width="75%" style="margin-left=auto;margin-right-auto;"></p>

<p>That&#39;s all! I hope my post can help you to understand how to detect texts inside an image.<br>
For recognizing the texts I will write a post about it in the future.<br>
If you have any question, <a href="https://twitter.com/intent/tweet?screen_name=niko_yuwono">send me a tweet!</a> If you like this post you can share it with your friends using share buttons below.</p>

  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Older</span>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  </body>
</html>
